import java.awt.*;

import javax.swing.*;
import javax.swing.border.EmptyBorder;
import javax.swing.text.AttributeSet;
import javax.swing.text.BadLocationException;
import javax.swing.text.Document;
import javax.swing.text.DocumentFilter;
import javax.swing.text.PlainDocument;



public class WindowForms extends JPanel {

	private static final long serialVersionUID = 1L;
	
	private DatePicker dp;
	private String[] labels = {"Libellé", "Montant", "Date"};
	private JTextField[] fields = new JTextField[labels.length];
	private BudgetModel model;
	
	public WindowForms(BudgetModel model, BudgetController controller){
		
		this.model = model;
		
		String[] values = {"", ""};
		
		setFont(this.model.tahomaFont12);
		setBorder(new EmptyBorder(0, 0, 0, 25));
		setLayout(new GridBagLayout());
	    GridBagConstraints gbc = new GridBagConstraints();
	    gbc.insets = new Insets(10,10,10,10);
	    gbc.anchor = GridBagConstraints.WEST;
		
		for (int i = 0; i < labels.length; i++) {
            gbc.gridx = 0;
            gbc.gridy = i;

            JLabel label = new JLabel();
            label.setText(labels[i] + ":");
            label.setFont(this.model.tahomaFont12);
            add(label, gbc);
            
            gbc.gridx = 1;
            if(labels[i] == "Date") {
            	dp = new DatePicker(this.model, controller);
            	add(dp, gbc);
            }else if(labels[i] == "Montant"){
            	JPanel montantPanel = new JPanel();
            	fields[i] = new JTextField(values[i], 5);
            	fields[i].setFont(this.model.tahomaFont12);
            	fields[i].setForeground(this.model.colorSelect);
            	JLabel labelMontant = new JLabel("CHF");
            	montantPanel.add(fields[i]);
            	montantPanel.add(labelMontant);
            	add(montantPanel, gbc);
            	PlainDocument doc = (PlainDocument) fields[i].getDocument();
                doc.setDocumentFilter(new IntFilter());    
            }else {
            	fields[i] = new JTextField(values[i], 15);
            	fields[i].setFont(this.model.tahomaFont12);
            	fields[i].setForeground(this.model.colorSelect);
            	add(fields[i], gbc);
            }
        }
		
		gbc.gridx = 0;
        gbc.gridy = labels.length;

        JButton btnCredit = new JButton("Crédit");
        JButton btnDebit = new JButton("Débit");
        
        //Font menu add
        btnCredit.setFont(model.tahomaFont12);
        btnDebit.setFont(model.tahomaFont12);

        // Inscrire les événements+
        btnCredit.addActionListener(e -> {
        	if(checkInput()) {
        		controller.addTransaction((String) fields[0].getText(), Float.parseFloat(fields[1].getText()), 0.0f);
        		clearFields();
        		System.out.println("Clearfield() a passé");
        	}else {
        		//Rajouter message d'erreur
        		JOptionPane.showMessageDialog(this, "Veuillez remplir tous les champs.", "Erreur", JOptionPane.WARNING_MESSAGE);

        	}
        });

        btnDebit.addActionListener(e -> {
			if(checkInput()) {
			     controller.addTransaction((String) fields[0].getText(), 0.0f, Float.parseFloat(fields[1].getText()));
			     clearFields();
			     System.out.println("Clearfield() a passé");
			}else {
				
				JOptionPane.showMessageDialog(this, "Veuillez remplir tous les champs.", "Erreur", JOptionPane.WARNING_MESSAGE);
				
			}
        });

        add(btnCredit, gbc);
        
        gbc.gridx = 1;
        add(btnDebit, gbc);
	}
	
	private Boolean checkInput() {
		//Boolean check = false;
		String day = this.model.getDay();
		String month = this.model.getMonth();
		String year = this.model.getYear();
		
		for (int i = 0; i < fields.length - 1; i++) { 
			if(fields[i].getText().isEmpty()) {
				return false;
			//String value = fields[i].getText();
			//if (!value.isEmpty() && day != null && month != null  && year != null) {
				//check = true;
			}//else {
				//check =  false;
			}
		
		return day != null && month != null && year != null;
				}
		//return check;
	
	
	private void clearFields() {
		for (int i = 0; i < fields.length-1; i++) {fields[i].setText("");}
	}

	
}

//Classe pour filtrer que les entiers positifs. 
class IntFilter extends DocumentFilter {
	   @Override
	   public void insertString(FilterBypass fb, int offset, String string,
	         AttributeSet attr) throws BadLocationException {

	      Document doc = fb.getDocument();
	      StringBuilder sb = new StringBuilder();
	      sb.append(doc.getText(0, doc.getLength()));
	      sb.insert(offset, string);

	      if (check(sb.toString())) {
	         super.insertString(fb, offset, string, attr);
	      } else {
	         // warn the user and don't allow the insert
	      }
	   }

	   private boolean check(String text) {
	      try {
	    	  if(text == "") {
	    		  return true;
	    	  }else {
	    		  Float.parseFloat(text);
	    		  return true;
	    	  }
	         
	      } catch (NumberFormatException e) {
	         return false;
	      }
	   }

	   @Override
	   public void replace(FilterBypass fb, int offset, int length, String text,
	         AttributeSet attrs) throws BadLocationException {

	      Document doc = fb.getDocument();
	      StringBuilder sb = new StringBuilder();
	      sb.append(doc.getText(0, doc.getLength()));
	      sb.replace(offset, offset + length, text);

	      if (check(sb.toString())) {
	         super.replace(fb, offset, length, text, attrs);
	      } else {
	         // warn the user and don't allow the insert
	      }

	   }
	}